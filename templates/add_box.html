
{% extends "base.html" %}

{% block title %}Add New Box - Hardware Inventory{% endblock %}

{% block content %}
<div class="container-fluid py-5">
    <div class="row justify-content-center">
        <div class="col-xl-8 col-lg-10">
            <div class="card shadow-lg border-0" style="border-radius: 20px;">
                <div class="card-header bg-success text-white py-4" style="border-radius: 20px 20px 0 0;">
                    <h2 class="mb-0 fw-bold text-center">
                        <i class="fas fa-plus-circle me-3"></i>
                        Add New Box to Inventory
                    </h2>
                </div>
                <div class="card-body p-5">
                    <form method="POST" id="addBoxForm">
                        <div class="row g-4">
                            <!-- Hardware Type -->
                            <div class="col-lg-6">
                                <label for="hardware_type" class="form-label fs-5 fw-semibold mb-3">
                                    <i class="fas fa-cogs me-2 text-primary"></i>Hardware Type
                                </label>
                                <select class="form-select form-select-lg mb-3" id="hardware_type" name="hardware_type" style="height: 60px; font-size: 1.1rem;">
                                    <option value="">Select existing type...</option>
                                    {% for type in types %}
                                    <option value="{{ type.name }}" 
                                        {{ 'selected' if form_data and form_data.get('hardware_type') == type.name }}>
                                        {{ type.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <input type="text" class="form-control form-control-lg" id="new_hardware_type" 
                                       name="new_hardware_type" placeholder="Or enter new type..."
                                       value="{{ form_data.get('new_hardware_type', '') if form_data }}"
                                       style="height: 60px; font-size: 1.1rem;">
                                <small class="form-text text-muted fs-6 mt-2">Leave existing selection empty to add new type</small>
                            </div>

                            <!-- Lot Number -->
                            <div class="col-lg-6">
                                <label for="lot_number" class="form-label fs-5 fw-semibold mb-3">
                                    <i class="fas fa-tag me-2 text-warning"></i>Lot Number
                                </label>
                                <select class="form-select form-select-lg mb-3" id="lot_number" name="lot_number" style="height: 60px; font-size: 1.1rem;">
                                    <option value="">Select existing lot...</option>
                                    {% for lot in lots %}
                                    <option value="{{ lot.name }}"
                                        {{ 'selected' if form_data and form_data.get('lot_number') == lot.name }}>
                                        {{ lot.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <input type="text" class="form-control form-control-lg" id="new_lot_number" 
                                       name="new_lot_number" placeholder="Or enter new lot..."
                                       value="{{ form_data.get('new_lot_number', '') if form_data }}"
                                       style="height: 60px; font-size: 1.1rem;">
                                <small class="form-text text-muted fs-6 mt-2">Leave existing selection empty to add new lot</small>
                            </div>

                            <!-- Box Number -->
                            <div class="col-lg-6">
                                <label for="box_number" class="form-label fs-5 fw-semibold mb-3">
                                    <i class="fas fa-box me-2 text-info"></i>Box Number
                                </label>
                                <input type="text" class="form-control form-control-lg" id="box_number" name="box_number" 
                                       placeholder="e.g., 001, A1, etc."
                                       value="{{ form_data.get('box_number', '') if form_data }}" required
                                       style="height: 60px; font-size: 1.1rem;">
                            </div>

                            <!-- Initial Quantity -->
                            <div class="col-lg-6">
                                <label for="initial_quantity" class="form-label fs-5 fw-semibold mb-3">
                                    <i class="fas fa-hashtag me-2 text-success"></i>Initial Quantity
                                </label>
                                <input type="number" class="form-control form-control-lg" id="initial_quantity" name="initial_quantity" 
                                       min="1" placeholder="Enter quantity"
                                       value="{{ form_data.get('initial_quantity', '') if form_data }}" required
                                       style="height: 60px; font-size: 1.1rem;">
                            </div>

                            <!-- Barcode -->
                            <div class="col-12">
                                <label for="barcode" class="form-label fs-5 fw-semibold mb-3">
                                    <i class="fas fa-barcode me-2 text-dark"></i>Barcode
                                </label>
                                <div class="input-group input-group-lg">
                                    <input type="text" class="form-control" id="barcode" name="barcode" 
                                           placeholder="Scan or enter barcode"
                                           value="{{ form_data.get('barcode', '') if form_data }}" required
                                           style="height: 60px; font-size: 1.1rem;">
                                    <button class="btn btn-outline-secondary px-4" type="button" id="scanBarcodeBtn" style="height: 60px;">
                                        <i class="fas fa-camera me-2"></i>Scan
                                    </button>
                                </div>
                                <small class="form-text text-muted fs-6 mt-2">Barcode must be unique across all boxes</small>
                            </div>

                            <!-- Operator -->
                            <div class="col-lg-6">
                                <label for="operator" class="form-label fs-5 fw-semibold mb-3">
                                    <i class="fas fa-user me-2 text-primary"></i>Operator
                                </label>
                                <input type="text" name="operator" id="operator" class="form-control form-control-lg" 
                                       placeholder="Enter operator name" 
                                       value="{{ form_data.get('operator', '') if form_data }}" required
                                       style="height: 60px; font-size: 1.1rem;">
                            </div>

                            <!-- QC Operator -->
                            <div class="col-lg-6">
                                <label for="qc_operator" class="form-label fs-5 fw-semibold mb-3">
                                    <i class="fas fa-user-check me-2 text-warning"></i>QC Operator
                                </label>
                                <input type="text" name="qc_operator" id="qc_operator" class="form-control form-control-lg" 
                                       placeholder="Enter QC operator name" 
                                       value="{{ form_data.get('qc_operator', '') if form_data }}" required
                                       style="height: 60px; font-size: 1.1rem;">
                                <small class="form-text text-muted fs-6 mt-2">QC Operator must be different from the Operator</small>
                            </div>
                        </div>

                        <!-- Preview Box ID -->
                        <div class="alert alert-info mt-4 p-4" id="boxIdPreview" style="display: none; border-radius: 15px;">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>Generated Box ID:
                                <span id="previewText" class="fw-bold text-primary"></span>
                            </h5>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between mt-5 pt-4">
                            <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg px-5 py-3">
                                <i class="fas fa-times me-2"></i>Cancel
                            </a>
                            <button type="submit" class="btn btn-success btn-lg px-5 py-3">
                                <i class="fas fa-plus me-2"></i>Add Box
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Barcode Scanner Container -->
<div id="barcodeScannerContainer" style="display: none;">
    <div class="modal fade" id="barcodeScannerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Scan Barcode</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="reader" style="width: 100%;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.card {
    transition: all 0.3s ease-in-out;
}

.form-control, .form-select {
    border-width: 2px;
    transition: all 0.3s ease-in-out;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
}

.btn-lg {
    font-weight: 600;
    min-width: 150px;
    transition: all 0.3s ease-in-out;
}

.btn-lg:hover {
    transform: translateY(-2px);
}

@media (max-width: 768px) {
    .card-body {
        padding: 2rem !important;
    }
    
    .form-control, .form-select {
        height: 50px !important;
        font-size: 1rem !important;
    }
    
    .btn-lg {
        padding: 12px 24px !important;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Box ID preview functionality
    function updateBoxIdPreview() {
        const hardwareType = document.getElementById('hardware_type').value || 
                           document.getElementById('new_hardware_type').value;
        const lotNumber = document.getElementById('lot_number').value || 
                         document.getElementById('new_lot_number').value;
        const boxNumber = document.getElementById('box_number').value;
        
        if (hardwareType && lotNumber && boxNumber) {
            // Sanitize components (basic client-side preview)
            const typeClean = hardwareType.replace(/[^\w\-]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
            const lotClean = lotNumber.replace(/[^\w\-]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
            const boxClean = boxNumber.replace(/[^\w\-]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
            
            const boxId = `${typeClean}_${lotClean}_${boxClean}`;
            document.getElementById('previewText').textContent = boxId;
            document.getElementById('boxIdPreview').style.display = 'block';
        } else {
            document.getElementById('boxIdPreview').style.display = 'none';
        }
    }
    
    // Add event listeners for preview
    ['hardware_type', 'new_hardware_type', 'lot_number', 'new_lot_number', 'box_number'].forEach(id => {
        document.getElementById(id).addEventListener('input', updateBoxIdPreview);
        document.getElementById(id).addEventListener('change', updateBoxIdPreview);
    });
    
    // Clear opposite field when typing in new field
    document.getElementById('new_hardware_type').addEventListener('input', function() {
        if (this.value) {
            document.getElementById('hardware_type').value = '';
        }
    });
    
    document.getElementById('hardware_type').addEventListener('change', function() {
        if (this.value) {
            document.getElementById('new_hardware_type').value = '';
        }
    });
    
    document.getElementById('new_lot_number').addEventListener('input', function() {
        if (this.value) {
            document.getElementById('lot_number').value = '';
        }
    });
    
    document.getElementById('lot_number').addEventListener('change', function() {
        if (this.value) {
            document.getElementById('new_lot_number').value = '';
        }
    });
    
    // Initial preview update
    updateBoxIdPreview();
    
    // Barcode scanner functionality (placeholder for now)
    document.getElementById('scanBarcodeBtn').addEventListener('click', function() {
        alert('Barcode scanning would be implemented here with camera access. For now, please enter the barcode manually.');
    });
});
</script>
{% endblock %}
