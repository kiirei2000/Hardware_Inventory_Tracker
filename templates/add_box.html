{% extends "base.html" %}
{% block title %}Add New Box - Hardware Inventory{% endblock %}

{% block content %}
  <!-- Centering wrapper -->
  <div
    class="d-flex align-items-center justify-content-center"
    style="height: calc(100vh - 60px); padding: 1.5rem;"
  >
    <div class="col-lg-8 col-xl-6">

      <!-- Header Card -->
      <div class="card shadow-lg mb-3 rounded overflow-hidden">
        <div class="card-body bg-primary text-white text-center py-3">
          <h4 class="mb-0">
            <i class="fas fa-plus-circle me-2"></i>
            Add New Box to Inventory
          </h4>
        </div>
      </div>

      <!-- Form Card -->
      <div class="card shadow-lg rounded overflow-hidden">
        <div class="card-body p-4">
          <form method="POST" id="addBoxForm">
            <div class="row gx-3 gy-2">
            
            <!-- Hardware Type -->
            <div class="col-md-6">
              <label for="hardware_type" class="form-label">
                <i class="fas fa-cogs me-2 text-primary"></i>Hardware Type
              </label>
              <select class="form-select form-select-lg" id="hardware_type" name="hardware_type">
                <option value="">Select existing type...</option>
                {% for type in types %}
                  <option value="{{ type.name }}"
                    {{ 'selected' if form_data and form_data.get('hardware_type') == type.name }}>
                    {{ type.name }}
                  </option>
                {% endfor %}
              </select>
              <input type="text" class="form-control form-control-lg mt-2" id="new_hardware_type"
                     name="new_hardware_type" placeholder="Or enter a new type..."
                     value="{{ form_data.get('new_hardware_type','') if form_data }}">
            </div>

            <!-- Lot Number -->
            <div class="col-md-6">
              <label for="lot_number" class="form-label">
                <i class="fas fa-tag me-2 text-primary"></i>Lot Number
              </label>
              <select class="form-select form-select-lg" id="lot_number" name="lot_number">
                <option value="">Select existing lot...</option>
                {% for lot in lots %}
                  <option value="{{ lot.name }}"
                    {{ 'selected' if form_data and form_data.get('lot_number') == lot.name }}>
                    {{ lot.name }}
                  </option>
                {% endfor %}
              </select>
              <input type="text" class="form-control form-control-lg mt-2" id="new_lot_number"
                     name="new_lot_number" placeholder="Or enter new lot..."
                     value="{{ form_data.get('new_lot_number','') if form_data }}">
            </div>

            <!-- Box Number -->
            <div class="col-md-6">
              <label for="box_number" class="form-label">
                <i class="fas fa-box me-2 text-primary"></i>Box Number
              </label>
              <input type="text" class="form-control form-control-lg" id="box_number" name="box_number"
                     placeholder="e.g., 001, A1, etc."
                     value="{{ form_data.get('box_number','') if form_data }}" required>
            </div>

            <!-- Initial Quantity -->
            <div class="col-md-6">
              <label for="initial_quantity" class="form-label">
                <i class="fas fa-hashtag me-2 text-primary"></i>Initial Quantity
              </label>
              <input type="number" class="form-control form-control-lg" id="initial_quantity" name="initial_quantity"
                     min="1" placeholder="Enter quantity"
                     value="{{ form_data.get('initial_quantity','') if form_data }}" required>
            </div>

            <!-- Barcode -->
            <div class="col-12">
              <label for="barcode" class="form-label">
                <i class="fas fa-barcode me-2 text-primary"></i>Barcode
              </label>
              <div class="input-group input-group-lg">
                <input type="text" class="form-control" id="barcode" name="barcode"
                       placeholder="Generated automatically or enter manually"
                       value="{{ form_data.get('barcode','') if form_data }}" required>
                <button type="button" class="btn btn-outline-purple" onclick="startBarcodeScanning()" title="Scan existing barcode">
                  <i class="fas fa-camera me-1"></i>Scan
                </button>
                  <button class="btn btn-outline-purple dropdown-toggle" type="button" id="generateBarcodeBtn" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-magic me-1"></i>Generate
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="generateBarcode('code128')">
                      <i class="fas fa-barcode me-2"></i>Barcode 128
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="generateBarcode('qrcode')">
                      <i class="fas fa-qrcode me-2"></i>QR Code
                    </a></li>
                  </ul>
                </div>
              </div>
              <!-- Barcode Preview -->
              <div id="barcodePreview" class="mt-2" style="display: none;">
                <div class="text-center p-2 border rounded bg-light">
                  <img id="barcodeImage" src="" alt="Barcode Preview" style="max-height: 80px;">
                  <div class="small text-muted mt-1">Barcode Preview</div>
                </div>
              </div>
            </div>

            <!-- Operator -->
            <div class="col-md-6">
              <label for="operator" class="form-label">
                <i class="fas fa-user me-2 text-primary"></i>Operator
              </label>
              <input type="text" name="operator" id="operator" class="form-control form-control-lg"
                     placeholder="Enter operator name"
                     value="{{ form_data.get('operator','') if form_data }}" required>
            </div>

            <!-- QC Operator -->
            <div class="col-md-6">
              <label for="qc_operator" class="form-label">
                <i class="fas fa-user-check me-2 text-primary"></i>QC Personnel
              </label>
              <input type="text" name="qc_operator" id="qc_operator" class="form-control form-control-lg"
                     placeholder="Enter QC personnel name"
                     value="{{ form_data.get('qc_operator','') if form_data }}" required>
            </div>
          </div>

          <!-- Preview Box ID -->
          <div class="alert alert-info mt-2 py-2" id="boxIdPreview" style="display: none;">
            <strong><i class="fas fa-info-circle me-2"></i>Generated Box ID:</strong>
            <span id="previewText"></span>
          </div>

          <!-- Submit Buttons -->
          <div class="d-flex justify-content-end gap-3 mt-3">
            <a href="{{ url_for('index') }}" class="btn btn-secondary btn-lg px-4">
              <i class="fas fa-times me-2"></i>Cancel
            </a>
            <button type="submit" class="btn btn-primary btn-lg px-4">
              <i class="fas fa-plus me-2"></i>Add Box
            </button>
          </div>
        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function updateBoxIdPreview() {
        const hardwareType = document.getElementById('hardware_type').value || 
                           document.getElementById('new_hardware_type').value;
        const lotNumber = document.getElementById('lot_number').value || 
                         document.getElementById('new_lot_number').value;
        const boxNumber = document.getElementById('box_number').value;
        
        if (hardwareType && lotNumber && boxNumber) {
            const typeClean = hardwareType.replace(/[^\w\-]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
            const lotClean = lotNumber.replace(/[^\w\-]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
            const boxClean = boxNumber.replace(/[^\w\-]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '');
            
            const boxId = `${typeClean}_${lotClean}_${boxClean}`;
            document.getElementById('previewText').textContent = boxId;
            document.getElementById('boxIdPreview').style.display = 'block';
        } else {
            document.getElementById('boxIdPreview').style.display = 'none';
        }
    }
    
    ['hardware_type', 'new_hardware_type', 'lot_number', 'new_lot_number', 'box_number'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('input', updateBoxIdPreview);
            element.addEventListener('change', updateBoxIdPreview);
        }
    });
    
    const newHardwareType = document.getElementById('new_hardware_type');
    const hardwareType = document.getElementById('hardware_type');
    const newLotNumber = document.getElementById('new_lot_number');
    const lotNumber = document.getElementById('lot_number');
    
    if (newHardwareType) {
        newHardwareType.addEventListener('input', function() {
            if (this.value && hardwareType) hardwareType.value = '';
        });
    }
    
    if (hardwareType) {
        hardwareType.addEventListener('change', function() {
            if (this.value && newHardwareType) newHardwareType.value = '';
        });
    }
    
    if (newLotNumber) {
        newLotNumber.addEventListener('input', function() {
            if (this.value && lotNumber) lotNumber.value = '';
        });
    }
    
    if (lotNumber) {
        lotNumber.addEventListener('change', function() {
            if (this.value && newLotNumber) newLotNumber.value = '';
        });
    }
    
    updateBoxIdPreview();
    
    // Also update barcode preview when manually entered
    const barcodeInputForPreview = document.getElementById('barcode');
    if (barcodeInputForPreview) {
        barcodeInputForPreview.addEventListener('input', function() {
            const barcode = this.value.trim();
            if (barcode) {
                fetch('/generate_barcode_api?barcode=' + encodeURIComponent(barcode) + '&type=qrcode')
                    .then(response => response.json())
                    .then(data => {
                        if (data.image) {
                            const barcodeImage = document.getElementById('barcodeImage');
                            const barcodePreview = document.getElementById('barcodePreview');
                            if (barcodeImage && barcodePreview) {
                                barcodeImage.src = data.image;
                                barcodePreview.style.display = 'block';
                            }
                        }
                    })
                    .catch(error => {
                        const barcodePreview = document.getElementById('barcodePreview');
                        if (barcodePreview) {
                            barcodePreview.style.display = 'none';
                        }
                    });
            } else {
                const barcodePreview = document.getElementById('barcodePreview');
                if (barcodePreview) {
                    barcodePreview.style.display = 'none';
                }
            }
        });
    }

    // Auto-generate QR code when page loads
    generateBarcode('qrcode');
});

function generateBarcode(type = 'qrcode') {
    fetch(`/generate_barcode_api?type=${type}`)
        .then(response => response.json())
        .then(data => {
            const barcodeInput = document.getElementById('barcode');
            const barcodeImage = document.getElementById('barcodeImage');
            const barcodePreview = document.getElementById('barcodePreview');
            
            if (barcodeInput) barcodeInput.value = data.barcode;
            if (data.image && barcodeImage && barcodePreview) {
                barcodeImage.src = data.image;
                barcodePreview.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error generating barcode:', error);
        });
}

function startBarcodeScanning() {
    // Use the same barcode scanning functionality from the log event page
    const barcodeInput = document.getElementById('barcode');
    if (!barcodeInput) return;
    
    // Try to start camera scanning (same as log event page)
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                // Create video element for scanning
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();
                
                // Show modal or scanning interface
                alert('Camera scanning started. Please use a barcode scanning app or manual entry for now.');
                
                // Stop the stream after a moment
                setTimeout(() => {
                    stream.getTracks().forEach(track => track.stop());
                }, 1000);
            })
            .catch(function(err) {
                // Fallback to manual entry
                const scannedBarcode = prompt('Please enter the scanned barcode:');
                if (scannedBarcode && scannedBarcode.trim()) {
                    barcodeInput.value = scannedBarcode.trim();
                    // Trigger input event to update preview
                    barcodeInput.dispatchEvent(new Event('input'));
                }
            });
    } else {
        // Fallback to manual entry
        const scannedBarcode = prompt('Please enter the scanned barcode:');
        if (scannedBarcode && scannedBarcode.trim()) {
            barcodeInput.value = scannedBarcode.trim();
            // Trigger input event to update preview
            barcodeInput.dispatchEvent(new Event('input'));
        }
    }
}
</script>
{% endblock %}
