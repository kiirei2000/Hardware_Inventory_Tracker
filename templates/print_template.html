{% extends "base.html" %}

{% block title %}Barcode Print Template{% endblock %}

{% block content %}
<style>
.custom-text-container {
    margin: 1rem 0;
    text-align: center;
}
.custom-text-input {
    width: 100%;
    min-height: 60px;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: none;
    font-size: 12px;
    font-family: Arial, sans-serif;
}
.text-controls {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
}

/* === Print ONLY rules === */
@page {
  size: letter portrait;
  margin: 0.5in;
}

@media print {
  /* 1) Hide all UI chrome except the print-area */
  body * {
    visibility: hidden !important;
  }
  #print-area, 
  #print-area * {
    visibility: visible !important;
  }
  
  /* Prevent the grid from shifting down */
  #print-area {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* 2) Kill header row (page title + buttons) */
  .row.align-items-center.mb-4 {
    display: none !important;
  }

  /* 3) Hide sidebar, footer, and any other wrappers */
  .sidebar,
  .app-footer,
  .navbar,
  .no-print,
  #generator-section,
  .text-controls,
  .btn,
  .dropdown,
  .finalize-controls {
    display: none !important;
  }

  /* 4) Remove any leftover scrollbars */
  html, body {
    overflow: visible !important;
  }
  ::-webkit-scrollbar {
    display: none !important;
  }

  /* 5) Force a 2-column, 5-row grid for Letter paper */
  .barcode-grid {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    grid-auto-rows: auto !important;
    gap: 0.5in !important;
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
  }

  /* 6) Keep each barcode card together */
  .barcode-item {
    break-inside: avoid-page !important;
    page-break-inside: avoid !important;
    border: 1px solid #000 !important;
    padding: 0.25in !important;
    text-align: center !important;
    background: white !important;
    border-radius: 0 !important;
  }

  /* 7) Clean text styling for print */
  .custom-text-input {
    border: none !important;
    background: transparent !important;
    padding: 0 !important;
    white-space: pre-wrap !important;
    font-size: 10pt !important;
    margin-top: 0.1in !important;
  }

  /* 8) Barcode image sizing */
  .barcode-image {
    max-width: 100% !important;
    height: auto !important;
    margin-bottom: 0.1in !important;
  }

  /* 9) Remove container padding */
  .container-fluid {
    padding: 0 !important;
    margin: 0 !important;
  }
}

.barcode-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    padding: 1rem 0;
}
.barcode-item {
    text-align: center;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    background: #fff;
    page-break-inside: avoid;
}
.barcode-image {
    max-width: 100%;
    height: auto;
    margin-bottom: 0.5rem;
}
</style>

<div class="container-fluid py-4">
  <!-- Header Row -->
  <div class="row align-items-center mb-4">
    <div class="col">
      <h2><i class="fas fa-print me-2"></i>Barcode Print Template</h2>
    </div>
    <div class="col-auto d-flex gap-2">
      <div class="btn-group">
        <button class="btn btn-primary btn-lg px-4 dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="fas fa-print me-2"></i>Print
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><button class="dropdown-item" type="button" onclick="printWithBarcodeType('qrcode', event)">
            <i class="fas fa-qrcode me-2"></i>Print as QR Codes
          </button></li>
          <li><button class="dropdown-item" type="button" onclick="printWithBarcodeType('code128', event)">
            <i class="fas fa-barcode me-2"></i>Print as Barcode 128
          </button></li>
        </ul>
      </div>
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg px-4">
        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
      </a>
    </div>
  </div>

  <!-- Generator Section -->
  {% if not barcode_data %}
  <div class="card mb-4" id="generator-section">
    <div class="card-header">
      <h5><i class="fas fa-tools me-2"></i>Barcode Generator</h5>
    </div>
    <div class="card-body">
      <div class="row justify-content-center g-3">
        <div class="col-md-4 d-grid">
          <button class="btn btn-info btn-lg w-100" onclick="generateRandomBarcodes('qrcode', event)">
            <i class="fas fa-random me-2"></i>Generate Random Barcodes
          </button>
        </div>
        <div class="col-md-4 d-grid">
          <a href="{{ url_for('dashboard') }}" class="btn btn-success btn-lg w-100">
            <i class="fas fa-list me-2"></i>Choose from Dashboard
          </a>
        </div>
        <div class="col-md-4 d-grid">
          <button class="btn btn-warning btn-lg w-100" onclick="showManualEntry()">
            <i class="fas fa-plus me-2"></i>Manual Entry
          </button>
        </div>
      </div>
      <div id="manual-entry" class="mt-3" style="display: none;">
        <form id="manual-barcode-form">
          <div class="row g-2">
            <div class="col-md-8">
              <input type="text" id="manual-barcode-input" class="form-control" placeholder="Enter barcode or generate new one">
            </div>
            <div class="col-md-2 d-grid">
              <button type="button" onclick="generateNewBarcode()" class="btn btn-secondary">
                <i class="fas fa-magic me-2"></i>Generate
              </button>
            </div>
            <div class="col-md-2 d-grid">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Print Template Grid -->
  <div id="print-area">
    {% if barcode_data %}
    <div class="barcode-grid">
      {% for item in barcode_data %}
      <div class="barcode-item">
        {% if item.image %}
        <img src="{{ item.image }}" alt="Barcode: {{ item.barcode }}" class="barcode-image">
        {% endif %}
        <div class="custom-text-container">
          <textarea class="custom-text-input" placeholder="Add custom text...">{% if item.type %}{{ item.barcode }}&#10;Box Type: {{ item.type }}{% else %}{{ item.barcode }}{% endif %}</textarea>
          <div class="text-controls">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteTextBox(this)">
              <i class="fas fa-trash me-1"></i>
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center text-muted py-5">
      <i class="fas fa-barcode fa-3x mb-3"></i>
      <h4>No barcodes to display</h4>
      <p>Use the generator above to create barcodes for printing</p>
    </div>
    {% endif %}
  </div>

  <!-- Finalize & Print -->
  {% if barcode_data %}
  <div class="d-flex justify-content-center my-4 finalize-controls">
    <button onclick="finalizeAndPrint()" class="btn btn-success btn-lg px-4">
      <i class="fas fa-print me-2"></i>Finalize & Print
    </button>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
let generatedBarcodes = [];

function generateRandomBarcodes(type = 'qrcode', event) {
    event?.preventDefault();
    
    // Show loading state
    const button = event?.target || document.querySelector('.btn-info');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    button.disabled = true;
    
    // Generate 6 random barcodes
    const promises = [];
    for (let i = 0; i < 6; i++) {
        promises.push(
            fetch(`/generate_barcode_api?type=${type}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Failed to generate barcode:', error);
                    return null;
                })
        );
    }
    
    Promise.all(promises).then(results => {
        // Filter out failed requests
        const validResults = results.filter(result => result !== null);
        
        if (validResults.length === 0) {
            alert('Failed to generate barcodes. Please try again.');
            return;
        }
        
        // Redirect to print template with generated barcodes
        const barcodes = validResults.map(item => item.barcode);
        const url = new URL(window.location.origin + '/print_template');
        barcodes.forEach(barcode => url.searchParams.append('barcodes', barcode));
        url.searchParams.set('type', type);
        window.location.href = url.toString();
        
    }).finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function generateNewBarcode() {
    fetch('/generate_barcode_api')
        .then(r => r.json())
        .then(data => {
            document.getElementById('manual-barcode-input').value = data.barcode;
        });
}

function showManualEntry() {
    document.getElementById('manual-entry').style.display = 'block';
}

function displayGeneratedBarcodes() {
    const container = document.getElementById('barcode-list');
    container.innerHTML = '';
    
    generatedBarcodes.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'barcode-item d-inline-block m-2';
        div.innerHTML = `
            <img src="${item.image}" alt="Barcode" style="max-width: 150px;">
            <div class="barcode-text">${item.barcode}</div>
            <button onclick="removeBarcode(${index})" class="btn btn-sm btn-danger mt-1">Remove</button>
        `;
        container.appendChild(div);
    });
    
    document.getElementById('generated-barcodes').style.display = 'block';
}

function removeBarcode(index) {
    generatedBarcodes.splice(index, 1);
    displayGeneratedBarcodes();
}

function printGeneratedBarcodes(type = 'qrcode') {
    const barcodes = generatedBarcodes.map(item => item.barcode);
    const url = new URL(window.location.origin + '/print_template');
    barcodes.forEach(barcode => url.searchParams.append('barcodes', barcode));
    url.searchParams.append('type', type);
    window.location.href = url.toString();
}

function printWithBarcodeType(type = 'qrcode', event) {
    event?.preventDefault();
    
    // Get current URL parameters and update with new barcode type
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('type', type);
    const newUrl = window.location.pathname + '?' + urlParams.toString();
    window.location.href = newUrl;
    
    return false;
}

function deleteTextBox(button) {
    const textContainer = button.closest('.custom-text-container');
    const textarea = textContainer.querySelector('.custom-text-input');
    
    if (confirm('Delete this text box?')) {
        textarea.value = '';
        textContainer.style.display = 'none';
    }
}

function finalizeAndPrint() {
    // Store original states for restoration
    const textareas = document.querySelectorAll('.custom-text-input');
    const originalStates = Array.from(textareas).map(textarea => ({
        textarea: textarea,
        value: textarea.value
    }));
    
    // Convert textareas to static text divs for clean printing
    textareas.forEach(textarea => {
        if (textarea.value.trim()) {
            const div = document.createElement('div');
            div.className = 'custom-text-print';
            div.style.cssText = 'font-size: 10pt; margin-top: 0.1in; text-align: center; word-wrap: break-word; white-space: pre-line;';
            div.textContent = textarea.value;
            textarea.parentElement.appendChild(div);
            textarea.style.display = 'none';
        }
    });
    
    // Trigger print dialog - CSS handles all layout and hiding
    window.print();
    
    // Restore everything after printing
    setTimeout(() => {
        // Remove temporary print divs and restore textareas
        originalStates.forEach(state => {
            const printDivs = state.textarea.parentElement.querySelectorAll('.custom-text-print');
            printDivs.forEach(div => div.remove());
            state.textarea.style.display = '';
        });
    }, 100);
}

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    const manualForm = document.getElementById('manual-barcode-form');
    if (manualForm) {
        manualForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const barcode = document.getElementById('manual-barcode-input').value.trim();
            if (barcode) {
                fetch('/generate_barcode_api?barcode=' + encodeURIComponent(barcode))
                    .then(r => r.json())
                    .then(data => {
                        generatedBarcodes.push({barcode: barcode, image: data.image});
                        displayGeneratedBarcodes();
                        document.getElementById('manual-barcode-input').value = '';
                    });
            }
        });
    }
});
</script>
{% endblock %}
