{% extends "base.html" %}

{% block title %}Barcode Print Template{% endblock %}

{% block content %}
<style>
.custom-text-container {
    margin: 1rem 0;
    text-align: center;
}
.custom-text-input {
    width: 100%;
    min-height: 60px;
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    resize: none;
    font-size: 12px;
    font-family: Arial, sans-serif;
}
.text-controls {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
}

/* === Print ONLY rules === */
@page {
  size: letter portrait;
  margin: 0.5in;
}

@media print {
  /* 1) Hide all UI chrome except the print-area */
  body * {
    visibility: hidden !important;
  }
  #print-area, 
  #print-area * {
    visibility: visible !important;
  }
  
  /* Prevent the grid from shifting down */
  #print-area {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  /* 2) Kill header row (page title + buttons) */
  .row.align-items-center.mb-4 {
    display: none !important;
  }

  /* 3) Hide sidebar, footer, and any other wrappers */
  .sidebar,
  .app-footer,
  .navbar,
  .no-print,
  #generator-section,
  .text-controls,
  .btn,
  .dropdown,
  .finalize-controls {
    display: none !important;
  }

  /* 4) Remove any leftover scrollbars */
  html, body {
    overflow: visible !important;
  }
  ::-webkit-scrollbar {
    display: none !important;
  }

  /* 5) Dynamic template grid - defaults to 2x5 for Letter paper */
  .barcode-grid {
    display: grid !important;
    grid-template-columns: repeat(2, 1fr) !important;
    grid-auto-rows: auto !important;
    gap: 0.5in !important;
    margin: 0 !important;
    padding: 0 !important;
    width: 100% !important;
  }

  /* 6) Keep each barcode card together */
  .barcode-item {
    break-inside: avoid-page !important;
    page-break-inside: avoid !important;
    border: 1px solid #000 !important;
    padding: 0.25in !important;
    text-align: center !important;
    background: white !important;
    border-radius: 0 !important;
  }

  /* 7) Clean text styling for print */
  .custom-text-input {
    border: none !important;
    background: transparent !important;
    padding: 0 !important;
    white-space: pre-wrap !important;
    font-size: 10pt !important;
    margin-top: 0.1in !important;
  }

  /* 8) Barcode image sizing */
  .barcode-image {
    max-width: 100% !important;
    height: auto !important;
    margin-bottom: 0.1in !important;
  }

  /* 9) Remove container padding */
  .container-fluid {
    padding: 0 !important;
    margin: 0 !important;
  }
}

.barcode-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    padding: 1rem 0;
}
.barcode-item {
    text-align: center;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem;
    background: #fff;
    page-break-inside: avoid;
}
.barcode-image {
    max-width: 100%;
    height: auto;
    margin-bottom: 0.5rem;
}
</style>

<div class="container-fluid py-4">
  <!-- Header Row -->
  <div class="row align-items-center mb-4">
    <div class="col">
      <h2><i class="fas fa-print me-2"></i>Barcode Print Template</h2>
    </div>
    <div class="col-auto d-flex gap-2">
      <div class="btn-group">
        <button class="btn btn-primary btn-lg px-4 dropdown-toggle" type="button" data-bs-toggle="dropdown">
          <i class="fas fa-print me-2"></i>Print
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li><button class="dropdown-item" type="button" onclick="printWithBarcodeType('qrcode', event)">
            <i class="fas fa-qrcode me-2"></i>Print as QR Codes
          </button></li>
          <li><button class="dropdown-item" type="button" onclick="printWithBarcodeType('code128', event)">
            <i class="fas fa-barcode me-2"></i>Print as Barcode 128
          </button></li>
        </ul>
      </div>
      <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-lg px-4">
        <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
      </a>
    </div>
  </div>

  <!-- Generator Section -->
  {% if not barcode_data %}
  <div class="card mb-4" id="generator-section">
    <div class="card-header">
      <h5><i class="fas fa-tools me-2"></i>Barcode Generator</h5>
    </div>
    <div class="card-body">
      <div class="row justify-content-center g-3">
        <div class="col-md-4 d-grid">
          <button class="btn btn-info btn-lg w-100" onclick="generateRandomBarcodes('qrcode', event)">
            <i class="fas fa-random me-2"></i>Generate Random Barcodes
          </button>
        </div>
        <div class="col-md-4 d-grid">
          <a href="{{ url_for('dashboard') }}" class="btn btn-success btn-lg w-100">
            <i class="fas fa-list me-2"></i>Choose from Dashboard
          </a>
        </div>
        <div class="col-md-4 d-grid">
          <button class="btn btn-warning btn-lg w-100" onclick="showManualEntry()">
            <i class="fas fa-plus me-2"></i>Manual Entry
          </button>
        </div>
      </div>
      <div id="manual-entry" class="mt-3" style="display: none;">
        <form id="manual-barcode-form">
          <div class="row g-2">
            <div class="col-md-8">
              <input type="text" id="manual-barcode-input" class="form-control" placeholder="Enter barcode or generate new one">
            </div>
            <div class="col-md-2 d-grid">
              <button type="button" onclick="generateNewBarcode()" class="btn btn-secondary">
                <i class="fas fa-magic me-2"></i>Generate
              </button>
            </div>
            <div class="col-md-2 d-grid">
              <button type="submit" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>Add
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Print Template Designer (Main Page) -->
  {% if not barcode_data %}
  <div class="card mb-4">
    <div class="card-header">
      <h5><i class="fas fa-layout me-2"></i>Print Template</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <!-- Template Presets -->
        <div class="col-md-4">
          <label class="form-label">Template</label>
          <select id="template-preset-main" class="form-select" onchange="applyTemplateMain()">
            <option value="">Select Template...</option>
            <option value="2x5-letter">2×5 Letter Paper</option>
            <option value="2x3-letter">2×3 Letter Paper</option>
            <option value="2x5-a4">2×5 A4 Paper</option>
            <option value="2x3-a4">2×3 A4 Paper</option>
          </select>
        </div>
        
        <!-- Barcode Size -->
        <div class="col-md-4">
          <label class="form-label">Barcode Size: <span id="size-display-main">100%</span></label>
          <input type="range" id="barcode-size-main" class="form-range" min="50" max="150" value="100" 
                 oninput="updateBarcodeSizeMain(this.value)">
        </div>
        
        <!-- Logo Upload -->
        <div class="col-md-4">
          <label class="form-label">Company Logo</label>
          <input type="file" id="logo-upload-main" class="form-control" accept="image/*" onchange="uploadLogoMain(this)">
        </div>
        
        <!-- Custom Text Fields -->
        <div class="col-md-6">
          <label class="form-label">Text Fields</label>
          <div class="btn-group w-100" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="toggleTextFieldMain('box-id')" id="field-box-id-main">Box ID</button>
            <button type="button" class="btn btn-outline-secondary" onclick="toggleTextFieldMain('type')" id="field-type-main">Type</button>
            <button type="button" class="btn btn-outline-secondary" onclick="toggleTextFieldMain('lot')" id="field-lot-main">Lot</button>
          </div>
        </div>
        
        <!-- Template Actions -->
        <div class="col-md-6">
          <label class="form-label">Template Actions</label>
          <div class="d-flex gap-2">
            <button onclick="saveTemplateMain()" class="btn btn-outline-primary btn-sm">
              <i class="fas fa-save"></i> Save
            </button>
            <button onclick="loadTemplateMain()" class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-folder-open"></i> Load
            </button>
            <button onclick="resetTemplateMain()" class="btn btn-outline-warning btn-sm">
              <i class="fas fa-undo"></i> Reset
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Print Template Designer -->
  {% if barcode_data %}
  <div class="card mb-4 no-print">
    <div class="card-header">
      <h5><i class="fas fa-layout me-2"></i>Print Template</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <!-- Template Presets -->
        <div class="col-md-4">
          <label class="form-label">Template</label>
          <select id="template-preset" class="form-select" onchange="applyTemplate()">
            <option value="">Select Template...</option>
            <option value="2x5-letter">2×5 Letter Paper</option>
            <option value="2x3-letter">2×3 Letter Paper</option>
            <option value="2x5-a4">2×5 A4 Paper</option>
            <option value="2x3-a4">2×3 A4 Paper</option>
          </select>
        </div>
        
        <!-- Barcode Size -->
        <div class="col-md-4">
          <label class="form-label">Barcode Size: <span id="size-display">100%</span></label>
          <input type="range" id="barcode-size" class="form-range" min="50" max="150" value="100" 
                 oninput="updateBarcodeSize(this.value)">
        </div>
        
        <!-- Logo Upload -->
        <div class="col-md-4">
          <label class="form-label">Company Logo</label>
          <input type="file" id="logo-upload" class="form-control" accept="image/*" onchange="uploadLogo(this)">
        </div>
        
        <!-- Custom Text Fields -->
        <div class="col-md-6">
          <label class="form-label">Text Fields</label>
          <div class="btn-group w-100" role="group">
            <button type="button" class="btn btn-outline-secondary" onclick="toggleTextField('box-id')" id="field-box-id">Box ID</button>
            <button type="button" class="btn btn-outline-secondary" onclick="toggleTextField('type')" id="field-type">Type</button>
            <button type="button" class="btn btn-outline-secondary" onclick="toggleTextField('lot')" id="field-lot">Lot</button>
          </div>
        </div>
        
        <!-- Template Actions -->
        <div class="col-md-6">
          <label class="form-label">Template Actions</label>
          <div class="d-flex gap-2">
            <button onclick="saveTemplate()" class="btn btn-outline-primary btn-sm">
              <i class="fas fa-save"></i> Save
            </button>
            <button onclick="loadTemplate()" class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-folder-open"></i> Load
            </button>
            <button onclick="resetTemplate()" class="btn btn-outline-warning btn-sm">
              <i class="fas fa-undo"></i> Reset
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Print Template Grid -->
  <div id="print-area">
    {% if barcode_data %}
    <div class="barcode-grid">
      {% for item in barcode_data %}
      <div class="barcode-item">
        {% if item.image %}
        <img src="{{ item.image }}" alt="Barcode: {{ item.barcode }}" class="barcode-image">
        {% endif %}
        <div class="custom-text-container">
          <textarea class="custom-text-input" placeholder="Add custom text...">{% if item.type %}{{ item.barcode }}&#10;Box Type: {{ item.type }}{% else %}{{ item.barcode }}{% endif %}</textarea>
          <div class="text-controls">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteTextBox(this)">
              <i class="fas fa-trash me-1"></i>
            </button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% else %}
    <div class="text-center text-muted py-5">
      <i class="fas fa-barcode fa-3x mb-3"></i>
      <h4>No barcodes to display</h4>
      <p>Use the generator above to create barcodes for printing</p>
    </div>
    {% endif %}
  </div>

  <!-- Finalize & Print -->
  {% if barcode_data %}
  <div class="d-flex justify-content-center my-4 finalize-controls">
    <button onclick="finalizeAndPrint()" class="btn btn-success btn-lg px-4">
      <i class="fas fa-print me-2"></i>Finalize & Print
    </button>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
let generatedBarcodes = [];

function generateRandomBarcodes(type = 'qrcode', event) {
    event?.preventDefault();
    
    // Show loading state
    const button = event?.target || document.querySelector('.btn-info');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    button.disabled = true;
    
    // Generate 6 random barcodes
    const promises = [];
    for (let i = 0; i < 6; i++) {
        promises.push(
            fetch(`/generate_barcode_api?type=${type}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    console.error('Failed to generate barcode:', error);
                    return null;
                })
        );
    }
    
    Promise.all(promises).then(results => {
        // Filter out failed requests
        const validResults = results.filter(result => result !== null);
        
        if (validResults.length === 0) {
            alert('Failed to generate barcodes. Please try again.');
            return;
        }
        
        // Redirect to print template with generated barcodes
        const barcodes = validResults.map(item => item.barcode);
        const url = new URL(window.location.origin + '/print_template');
        barcodes.forEach(barcode => url.searchParams.append('barcodes', barcode));
        url.searchParams.set('type', type);
        window.location.href = url.toString();
        
    }).finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function generateNewBarcode() {
    fetch('/generate_barcode_api')
        .then(r => r.json())
        .then(data => {
            document.getElementById('manual-barcode-input').value = data.barcode;
        });
}

function showManualEntry() {
    document.getElementById('manual-entry').style.display = 'block';
}

function displayGeneratedBarcodes() {
    const container = document.getElementById('barcode-list');
    container.innerHTML = '';
    
    generatedBarcodes.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'barcode-item d-inline-block m-2';
        div.innerHTML = `
            <img src="${item.image}" alt="Barcode" style="max-width: 150px;">
            <div class="barcode-text">${item.barcode}</div>
            <button onclick="removeBarcode(${index})" class="btn btn-sm btn-danger mt-1">Remove</button>
        `;
        container.appendChild(div);
    });
    
    document.getElementById('generated-barcodes').style.display = 'block';
}

function removeBarcode(index) {
    generatedBarcodes.splice(index, 1);
    displayGeneratedBarcodes();
}

function printGeneratedBarcodes(type = 'qrcode') {
    const barcodes = generatedBarcodes.map(item => item.barcode);
    const url = new URL(window.location.origin + '/print_template');
    barcodes.forEach(barcode => url.searchParams.append('barcodes', barcode));
    url.searchParams.append('type', type);
    window.location.href = url.toString();
}

function printWithBarcodeType(type = 'qrcode', event) {
    event?.preventDefault();
    
    // Get current URL parameters and update with new barcode type
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('type', type);
    const newUrl = window.location.pathname + '?' + urlParams.toString();
    window.location.href = newUrl;
    
    return false;
}

function deleteTextBox(button) {
    const textContainer = button.closest('.custom-text-container');
    const textarea = textContainer.querySelector('.custom-text-input');
    
    if (confirm('Delete this text box?')) {
        textarea.value = '';
        textContainer.style.display = 'none';
    }
}

function finalizeAndPrint() {
    // Check if template is selected
    const templateSelect = document.getElementById('template-preset');
    if (templateSelect && !templateSelect.value) {
        alert('Please select a print template before printing.');
        return;
    }
    
    // Store original states for restoration
    const textareas = document.querySelectorAll('.custom-text-input');
    const originalStates = Array.from(textareas).map(textarea => ({
        textarea: textarea,
        value: textarea.value
    }));
    
    // Convert textareas to static text divs for clean printing
    textareas.forEach(textarea => {
        if (textarea.value.trim()) {
            const div = document.createElement('div');
            div.className = 'custom-text-print';
            div.style.cssText = 'font-size: 10pt; margin-top: 0.1in; text-align: center; word-wrap: break-word; white-space: pre-line;';
            div.textContent = textarea.value;
            textarea.parentElement.appendChild(div);
            textarea.style.display = 'none';
        }
    });
    
    // Trigger print dialog - CSS handles all layout and hiding
    window.print();
    
    // Restore everything after printing
    setTimeout(() => {
        // Remove temporary print divs and restore textareas
        originalStates.forEach(state => {
            const printDivs = state.textarea.parentElement.querySelectorAll('.custom-text-print');
            printDivs.forEach(div => div.remove());
            state.textarea.style.display = '';
        });
    }, 100);
}

// Template System - Lightweight MVP
const templatePresets = {
    '2x5-letter': { columns: 2, rows: 5, paper: 'letter', gap: '0.5in', margin: '0.5in' },
    '2x3-letter': { columns: 2, rows: 3, paper: 'letter', gap: '0.6in', margin: '0.75in' },
    '2x5-a4': { columns: 2, rows: 5, paper: 'a4', gap: '1.2cm', margin: '1.5cm' },
    '2x3-a4': { columns: 2, rows: 3, paper: 'a4', gap: '1.5cm', margin: '2cm' }
};

let currentTemplate = null;
let currentLogo = null;

function applyTemplate() {
    const select = document.getElementById('template-preset');
    const template = templatePresets[select.value];
    
    if (!template) {
        resetTemplate();
        return;
    }
    
    currentTemplate = template;
    
    // Generate scoped CSS for print area only
    const css = `
    @media print {
        @page {
            size: ${template.paper} portrait;
            margin: ${template.margin};
        }
        
        .barcode-grid {
            grid-template-columns: repeat(${template.columns}, 1fr) !important;
            gap: ${template.gap} !important;
        }
    }
    `;
    
    // Inject or update template-specific styles
    let styleEl = document.getElementById('template-styles');
    if (!styleEl) {
        styleEl = document.createElement('style');
        styleEl.id = 'template-styles';
        document.head.appendChild(styleEl);
    }
    styleEl.textContent = css;
    
    // Save to localStorage for persistence
    localStorage.setItem('printTemplate', JSON.stringify({
        preset: select.value,
        template: template,
        logo: currentLogo
    }));
}

function updateBarcodeSize(value) {
    document.getElementById('size-display').textContent = value + '%';
    
    // Update barcode image sizes in real-time
    const scale = value / 100;
    const barcodeImages = document.querySelectorAll('.barcode-image');
    barcodeImages.forEach(img => {
        img.style.transform = `scale(${scale})`;
        img.style.transformOrigin = 'center';
    });
    
    // Save to localStorage
    localStorage.setItem('barcodeSize', value);
}

function uploadLogo(input) {
    const file = input.files[0];
    if (!file) return;
    
    // Validate file size (max 1MB for offline compatibility)
    if (file.size > 1024 * 1024) {
        alert('Logo file too large. Please use an image under 1MB.');
        input.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        currentLogo = e.target.result;
        
        // Add logo to each barcode item
        const barcodeItems = document.querySelectorAll('.barcode-item');
        barcodeItems.forEach(item => {
            // Remove existing logo if present
            const existingLogo = item.querySelector('.template-logo');
            if (existingLogo) existingLogo.remove();
            
            // Add new logo
            const logo = document.createElement('img');
            logo.className = 'template-logo';
            logo.src = currentLogo;
            logo.style.cssText = 'max-width: 60px; max-height: 30px; margin-bottom: 0.1in; display: block; margin-left: auto; margin-right: auto;';
            
            // Insert logo before barcode image
            const barcodeImg = item.querySelector('.barcode-image');
            if (barcodeImg) {
                item.insertBefore(logo, barcodeImg);
            }
        });
        
        // Save to localStorage
        localStorage.setItem('templateLogo', currentLogo);
    };
    reader.readAsDataURL(file);
}

function toggleTextField(fieldType) {
    const button = document.getElementById(`field-${fieldType}`);
    const isActive = button.classList.contains('btn-secondary');
    
    if (isActive) {
        button.classList.remove('btn-secondary');
        button.classList.add('btn-outline-secondary');
    } else {
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-secondary');
    }
    
    // Save active fields to localStorage
    const activeFields = Array.from(document.querySelectorAll('[id^="field-"]'))
        .filter(btn => btn.classList.contains('btn-secondary'))
        .map(btn => btn.id.replace('field-', ''));
    
    localStorage.setItem('activeFields', JSON.stringify(activeFields));
}

function saveTemplate() {
    const name = prompt('Enter template name:');
    if (!name) return;
    
    const savedTemplates = JSON.parse(localStorage.getItem('savedTemplates') || '{}');
    savedTemplates[name] = {
        preset: document.getElementById('template-preset').value,
        barcodeSize: document.getElementById('barcode-size').value,
        logo: currentLogo,
        activeFields: JSON.parse(localStorage.getItem('activeFields') || '[]')
    };
    
    localStorage.setItem('savedTemplates', JSON.stringify(savedTemplates));
    alert(`Template "${name}" saved successfully!`);
}

function loadTemplate() {
    const savedTemplates = JSON.parse(localStorage.getItem('savedTemplates') || '{}');
    const names = Object.keys(savedTemplates);
    
    if (names.length === 0) {
        alert('No saved templates found.');
        return;
    }
    
    const name = prompt('Load template:\n' + names.map((n, i) => `${i+1}. ${n}`).join('\n') + '\n\nEnter template name:');
    if (!name || !savedTemplates[name]) return;
    
    const template = savedTemplates[name];
    
    // Apply saved template
    document.getElementById('template-preset').value = template.preset;
    document.getElementById('barcode-size').value = template.barcodeSize;
    
    applyTemplate();
    updateBarcodeSize(template.barcodeSize);
    
    if (template.logo) {
        currentLogo = template.logo;
        // Trigger logo application
        const barcodeItems = document.querySelectorAll('.barcode-item');
        barcodeItems.forEach(item => {
            const existingLogo = item.querySelector('.template-logo');
            if (existingLogo) existingLogo.remove();
            
            const logo = document.createElement('img');
            logo.className = 'template-logo';
            logo.src = currentLogo;
            logo.style.cssText = 'max-width: 60px; max-height: 30px; margin-bottom: 0.1in; display: block; margin-left: auto; margin-right: auto;';
            
            const barcodeImg = item.querySelector('.barcode-image');
            if (barcodeImg) {
                item.insertBefore(logo, barcodeImg);
            }
        });
    }
    
    // Restore active fields
    template.activeFields.forEach(fieldType => {
        const button = document.getElementById(`field-${fieldType}`);
        if (button) {
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-secondary');
        }
    });
}

function resetTemplate() {
    // Clear selections
    document.getElementById('template-preset').value = '';
    document.getElementById('barcode-size').value = 100;
    document.getElementById('size-display').textContent = '100%';
    document.getElementById('logo-upload').value = '';
    
    // Reset field buttons
    document.querySelectorAll('[id^="field-"]').forEach(btn => {
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-outline-secondary');
    });
    
    // Remove template styles
    const styleEl = document.getElementById('template-styles');
    if (styleEl) styleEl.remove();
    
    // Remove logos
    document.querySelectorAll('.template-logo').forEach(logo => logo.remove());
    
    // Reset barcode sizes
    document.querySelectorAll('.barcode-image').forEach(img => {
        img.style.transform = '';
    });
    
    // Clear localStorage
    localStorage.removeItem('printTemplate');
    localStorage.removeItem('barcodeSize');
    localStorage.removeItem('templateLogo');
    localStorage.removeItem('activeFields');
    
    currentTemplate = null;
    currentLogo = null;
}

// Initialize template system on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load saved template if available
    const savedTemplate = localStorage.getItem('printTemplate');
    const savedSize = localStorage.getItem('barcodeSize');
    const savedLogo = localStorage.getItem('templateLogo');
    const savedFields = localStorage.getItem('activeFields');
    
    if (savedTemplate) {
        const template = JSON.parse(savedTemplate);
        document.getElementById('template-preset').value = template.preset;
        applyTemplate();
    }
    
    if (savedSize) {
        document.getElementById('barcode-size').value = savedSize;
        updateBarcodeSize(savedSize);
    }
    
    if (savedLogo) {
        currentLogo = savedLogo;
        // Apply logo to existing barcodes
        setTimeout(() => {
            const input = document.getElementById('logo-upload');
            if (input) {
                const fakeEvent = { target: { result: savedLogo } };
                // Trigger logo application logic
                uploadLogo.reader = fakeEvent;
            }
        }, 100);
    }
    
    if (savedFields) {
        const fields = JSON.parse(savedFields);
        fields.forEach(fieldType => {
            const button = document.getElementById(`field-${fieldType}`);
            if (button) {
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-secondary');
            }
        });
    }
    
    // Add graceful fallback CSS for non-JS users
    if (!document.getElementById('fallback-styles')) {
        const fallbackCSS = `
        @media print {
            .barcode-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5in !important;
            }
        }
        `;
        const fallbackStyle = document.createElement('style');
        fallbackStyle.id = 'fallback-styles';
        fallbackStyle.textContent = fallbackCSS;
        document.head.appendChild(fallbackStyle);
    }
}

// Missing functions from original template
let generatedBarcodes = [];

function generateRandomBarcodes(type = 'qrcode', event = null) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // Generate 10 random barcodes
    const barcodes = [];
    for (let i = 0; i < 10; i++) {
        const randomBarcode = Math.random().toString(36).substring(2, 12).toUpperCase();
        barcodes.push(randomBarcode);
    }
    
    // Generate barcode images
    const promises = barcodes.map(barcode => 
        fetch('/generate_barcode_api?barcode=' + encodeURIComponent(barcode) + '&type=' + type)
            .then(r => r.json())
            .then(data => ({barcode: barcode, image: data.image, type: type}))
    );
    
    Promise.all(promises).then(results => {
        generatedBarcodes = results;
        displayGeneratedBarcodes();
    }).catch(err => {
        console.error('Error generating barcodes:', err);
        alert('Error generating barcodes. Please try again.');
    });
}

function showManualEntry(event = null) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const barcode = prompt('Enter barcode data:');
    if (barcode && barcode.trim()) {
        fetch('/generate_barcode_api?barcode=' + encodeURIComponent(barcode.trim()))
            .then(r => r.json())
            .then(data => {
                generatedBarcodes.push({barcode: barcode.trim(), image: data.image});
                displayGeneratedBarcodes();
            })
            .catch(err => {
                console.error('Error generating barcode:', err);
                alert('Error generating barcode. Please try again.');
            });
    }
}

function generateNewBarcode() {
    const randomBarcode = Math.random().toString(36).substring(2, 12).toUpperCase();
    document.getElementById('manual-barcode-input').value = randomBarcode;
}

function displayGeneratedBarcodes() {
    // Redirect to print template with generated barcodes
    const barcodeData = generatedBarcodes.map(item => 
        `${item.barcode}:${item.image}${item.type ? ':' + item.type : ''}`
    ).join(',');
    
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('barcodes', barcodeData);
    
    const newUrl = window.location.pathname + '?' + urlParams.toString();
    window.location.href = newUrl;
}

function printWithBarcodeType(type, event = null) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('type', type);
    const newUrl = window.location.pathname + '?' + urlParams.toString();
    window.location.href = newUrl;
    
    return false;
}

// Main page template functions
function applyTemplateMain() {
    const select = document.getElementById('template-preset-main');
    const template = templatePresets[select.value];
    
    if (!template) {
        resetTemplateMain();
        return;
    }
    
    // Store template settings for later use
    localStorage.setItem('printTemplateMain', JSON.stringify({
        preset: select.value,
        template: template
    }));
}

function updateBarcodeSizeMain(value) {
    document.getElementById('size-display-main').textContent = value + '%';
    localStorage.setItem('barcodeSizeMain', value);
}

function uploadLogoMain(input) {
    const file = input.files[0];
    if (!file) return;
    
    if (file.size > 1024 * 1024) {
        alert('Logo file too large. Please use an image under 1MB.');
        input.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        localStorage.setItem('templateLogoMain', e.target.result);
    };
    reader.readAsDataURL(file);
}

function toggleTextFieldMain(fieldType) {
    const button = document.getElementById(`field-${fieldType}-main`);
    const isActive = button.classList.contains('btn-secondary');
    
    if (isActive) {
        button.classList.remove('btn-secondary');
        button.classList.add('btn-outline-secondary');
    } else {
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-secondary');
    }
    
    const activeFields = Array.from(document.querySelectorAll('[id^="field-"][id$="-main"]'))
        .filter(btn => btn.classList.contains('btn-secondary'))
        .map(btn => btn.id.replace('field-', '').replace('-main', ''));
    
    localStorage.setItem('activeFieldsMain', JSON.stringify(activeFields));
}

function saveTemplateMain() {
    const name = prompt('Enter template name:');
    if (!name) return;
    
    const savedTemplates = JSON.parse(localStorage.getItem('savedTemplatesMain') || '{}');
    savedTemplates[name] = {
        preset: document.getElementById('template-preset-main').value,
        barcodeSize: document.getElementById('barcode-size-main').value,
        logo: localStorage.getItem('templateLogoMain'),
        activeFields: JSON.parse(localStorage.getItem('activeFieldsMain') || '[]')
    };
    
    localStorage.setItem('savedTemplatesMain', JSON.stringify(savedTemplates));
    alert(`Template "${name}" saved successfully!`);
}

function loadTemplateMain() {
    const savedTemplates = JSON.parse(localStorage.getItem('savedTemplatesMain') || '{}');
    const names = Object.keys(savedTemplates);
    
    if (names.length === 0) {
        alert('No saved templates found.');
        return;
    }
    
    const name = prompt('Load template:\n' + names.map((n, i) => `${i+1}. ${n}`).join('\n') + '\n\nEnter template name:');
    if (!name || !savedTemplates[name]) return;
    
    const template = savedTemplates[name];
    
    document.getElementById('template-preset-main').value = template.preset;
    document.getElementById('barcode-size-main').value = template.barcodeSize;
    
    applyTemplateMain();
    updateBarcodeSizeMain(template.barcodeSize);
    
    if (template.logo) {
        localStorage.setItem('templateLogoMain', template.logo);
    }
    
    template.activeFields.forEach(fieldType => {
        const button = document.getElementById(`field-${fieldType}-main`);
        if (button) {
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-secondary');
        }
    });
}

function resetTemplateMain() {
    document.getElementById('template-preset-main').value = '';
    document.getElementById('barcode-size-main').value = 100;
    document.getElementById('size-display-main').textContent = '100%';
    document.getElementById('logo-upload-main').value = '';
    
    document.querySelectorAll('[id^="field-"][id$="-main"]').forEach(btn => {
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-outline-secondary');
    });
    
    localStorage.removeItem('printTemplateMain');
    localStorage.removeItem('barcodeSizeMain');
    localStorage.removeItem('templateLogoMain');
    localStorage.removeItem('activeFieldsMain');
}

// Wait for DOM to be ready
document.addEventListener('DOMContentLoaded', function() {
    // Initialize template system regardless of page state
    initializeTemplateSystem();
    
    const manualForm = document.getElementById('manual-barcode-form');
    if (manualForm) {
        manualForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const barcode = document.getElementById('manual-barcode-input').value.trim();
            if (barcode) {
                fetch('/generate_barcode_api?barcode=' + encodeURIComponent(barcode))
                    .then(r => r.json())
                    .then(data => {
                        generatedBarcodes.push({barcode: barcode, image: data.image});
                        displayGeneratedBarcodes();
                        document.getElementById('manual-barcode-input').value = '';
                    });
            }
        });
    }
});

function initializeTemplateSystem() {
    // Load saved template if available - for barcode display page
    const savedTemplate = localStorage.getItem('printTemplate');
    const savedSize = localStorage.getItem('barcodeSize');
    const savedLogo = localStorage.getItem('templateLogo');
    const savedFields = localStorage.getItem('activeFields');
    
    // Initialize barcode display page template
    const templateSelect = document.getElementById('template-preset');
    if (templateSelect && savedTemplate) {
        const template = JSON.parse(savedTemplate);
        templateSelect.value = template.preset;
        applyTemplate();
    }
    
    const barcodeSlider = document.getElementById('barcode-size');
    if (barcodeSlider && savedSize) {
        barcodeSlider.value = savedSize;
        updateBarcodeSize(savedSize);
    }
    
    if (savedFields) {
        const fields = JSON.parse(savedFields);
        fields.forEach(fieldType => {
            const button = document.getElementById(`field-${fieldType}`);
            if (button) {
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-secondary');
            }
        });
    }
    
    // Initialize main page template
    const templateSelectMain = document.getElementById('template-preset-main');
    const savedTemplateMain = localStorage.getItem('printTemplateMain');
    const savedSizeMain = localStorage.getItem('barcodeSizeMain');
    const savedFieldsMain = localStorage.getItem('activeFieldsMain');
    
    if (templateSelectMain && savedTemplateMain) {
        const template = JSON.parse(savedTemplateMain);
        templateSelectMain.value = template.preset;
        applyTemplateMain();
    }
    
    const barcodeSliderMain = document.getElementById('barcode-size-main');
    if (barcodeSliderMain && savedSizeMain) {
        barcodeSliderMain.value = savedSizeMain;
        updateBarcodeSizeMain(savedSizeMain);
    }
    
    if (savedFieldsMain) {
        const fields = JSON.parse(savedFieldsMain);
        fields.forEach(fieldType => {
            const button = document.getElementById(`field-${fieldType}-main`);
            if (button) {
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-secondary');
            }
        });
    }
    
    // Add graceful fallback CSS for non-JS users
    if (!document.getElementById('fallback-styles')) {
        const fallbackCSS = `
        @media print {
            .barcode-grid {
                display: grid !important;
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5in !important;
            }
        }
        `;
        const fallbackStyle = document.createElement('style');
        fallbackStyle.id = 'fallback-styles';
        fallbackStyle.textContent = fallbackCSS;
        document.head.appendChild(fallbackStyle);
    }
}
</script>
{% endblock %}
